---
title: Functional enrichment analysis
output:
    html_document:
        code_folding: hide
        toc: true
        toc_float: true
        toc_depth: 3
---

```{r}
library(AnnotationHub)
library(dplyr)
```

# Functional enrichment analysis

Functional enrichment analysis tests to see if the genes of interest (e.g., up,
down, changed in a particular contrast) are found more often than expected in
a particular annotation category.

```{r load_helpers}
# Load the lcdbwf R package, which is stored locally.
# This package has many custom functions used throughout this document.
devtools::document('../../../lib/lcdbwf')
devtools::load_all('../../../lib/lcdbwf')

config <- yaml::yaml.load_file('config.yaml')
```

```{r load, cache=TRUE, cache.extra=file.info('combined.Rds')$mtime}
obj <- readRDS('combined.Rds')
res_list <- obj$res_list
dds_list <- obj$dds_list
```

```{r functional_enrichment_prep, cache=TRUE, config=config$annotation$keytype, eval=config$toggle$functional_enrichment, dependson='load'}

# We assume that keys are unique across all term2gene_lists.
term2gene_list <- get_go_term2gene(config)
term2name <- get_go_descriptions()

# Get all of MSigDB, although we may only use subsets of it
msigdb_df <- get_msigdb_df(config)
msigdb_term2gene_list <- get_msigdb_term2gene_list(msigdb_df)
msigdb_term2name <- get_msigdb_term2name(msigdb_df)

# We need to assign each key to its respective term2name dataframe (or NULL if
# none)
ontology_term2name_mapping <- c(
  lapply(term2gene_list, function(x) term2name),
  lapply(msigdb_term2gene_list, function(x) NULL)
)

ontology_list <- c(term2gene_list, msigdb_term2gene_list)
```

```{r enrich, cache=TRUE, eval=config$toggle$functional_enrichment, config=c(config$main, config$functional_enrichment), dependson=c('functional_enrichment_prep', 'assemble_variables')}

all_enrich <- list()

for (name in names(res_list)){
  all_enrich[[name]] <- list()

  for (direction in config$functional_enrichment$directions){
    all_enrich[[name]][[direction]] <- list()

    for (ont in names(config$functional_enrichment$ontologies)){
      term2gene <- ontology_list[[ont]]
      term2name <- ontology_term2name_mapping[[ont]]
      enrich_res <- run_enrichment(
        res_list[[name]],
        direction=direction,
        TERM2GENE=term2gene,
        TERM2NAME=term2name,
        config=config,
        kind=config$functional_enrichment$kind
      )
      if (!is.null(enrich_res) && nrow(enrich_res@result) > 5){
        all_enrich[[name]][[direction]][[ont]] <- enrich_res
      } else {
        all_enrich[[name]][[direction]][[ont]] <- NULL
      }
    }
  }
}
```


```{r functional_enrichment_plots}
# Interestingly, it's the *caching* that causes this to hang for a loooong time.
dotplot_list <- enrich_list_lapply(all_enrich, dotplots, config=config, send_names=TRUE)
emapplot_list <- enrich_list_lapply(all_enrich, emapplots, config=config, send_names=TRUE)
cnetplot_list <- enrich_list_lapply(all_enrich, cnetplots, config=config, send_names=TRUE)
```

```{r, results='asis'}
mdcat("There are many different databases that annotate genes into sets.",
      "The following sets are used here:")

knitr::kable(config$functional_enrichment$ontologies %>% as.data.frame %>% t())
```

# Plots {.tabset}

```{r, results='asis'}

for (name in names(res_list)){
  mdcat("## ", name, "{.tabset}")
  for (direction in config$functional_enrichment$directions){
    mdcat("### ", direction, "{.tabset}")
    if (length(all_enrich[[name]][[direction]]) == 0){
      mdcat("Too few genes differentially expressed.")
      next
    }
    for (ont in names(all_enrich[[name]][[direction]])){
      mdcat("#### ", ont, "{.tabset}")

      mdcat("##### dotplot")
      print(dotplot_list[[name]][[direction]][[ont]])

      mdcat("##### emapplot")
      print(emapplot_list[[name]][[direction]][[ont]])

      mdcat("##### cnetplot")
      print(cnetplot_list[[name]][[direction]][[ont]])
    }
  }
}


```

# Session info
For reproducibility purposes, here is the output of `sessionInfo()` showing the
versions of all packages used here.

```{r, collapse=FALSE}
sessionInfo()
```
