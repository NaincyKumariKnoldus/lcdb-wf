import sys
sys.path.insert(0, srcdir('../..'))
import os
from lcdblib.utils import utils
from lib import common
from lib.patterns_targets import RNASeqConfig, ChIPSeqConfig

rnaseq_config = RNASeqConfig('config/config.yaml', 'config/rnaseq_patterns.yaml', workdir='../rnaseq')
chipseq_config = ChIPSeqConfig('config/config.yaml', 'config/chipseq_patterns.yaml', workdir='../chipseq')


subworkflow rnaseq:
    configfile: rnaseq_config.path
    workdir: '../rnaseq'


subworkflow chipseq:
    configfile: chipseq_config.path
    workdir: '../chipseq'


rule peak_count:
    input: chipseq(utils.flatten(chipseq_config.targets['peaks']))
    output: 'figures/peak_count/peak_count.tsv'
    run:
        import pandas as pd
        import pybedtools
        df = []
        for i in input:
            toks = i.split('/')
            peakcaller = toks[-3]
            label = toks[-2]
            df.append(dict(peakcaller=peakcaller, label=label, count=len(pybedtools.BedTool(i))))
        pd.DataFrame(df)[['peakcaller', 'label', 'count']].to_csv(output[0], sep='\t', index=False)


# vim: ft=python
